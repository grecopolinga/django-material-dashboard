{% extends "layouts/base.html" %}
{% load i18n static %}

{% block title %} Tables {% endblock title %}

{% block content %}
    <div class="container-fluid py-4">
      <!-- #region Map Designation -->
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2" >
              <div class="shadow-dark border-radius-lg pt-4 pb-3" style="background-color: rgb(27, 107, 16);">
                <h6 class="text-white text-capitalize ps-3">Waste Bin Designation Map</h6>
              </div>
            </div>
            <!-- Insert Map Inside this Div-->
            <div class="card-body px-4 pb-2">
              <!-- Plot the areas on the img -->
              <!-- <map name="map_zones">
                <area
                    href="https://facebook.com"
                    alt="Zone 1 area"
                    target="_blank"
                    shape="poly"
                    coords="2.1%,42%, 48%,42%, 48%,87.1%, 2.1%,87.1%"
                >
              </map> -->
              <img 
                  src="{% static '/img/map.png' %}"
                  alt="Zone 1"
                  width="100%"
                  height="450"
                  usemap="#map_zones"
              >
              <a href="#" id="Zone1" style="position: absolute; left: 5%; top: 50%; width: 43%; height: 37%;"></a>
              <a href="#" id="Zone2" style="position: absolute; left: 33%; top: 27%; width: 23%; height: 23%;"></a>
              <a href="#" id="Zone2b" style="position: absolute; left: 48%; top: 50%; width: 7%; height: 37%;"></a>
              <a href="#" id="Zone2c" style="position: absolute; left: 55%; top: 45%; width: 13%; height: 21%;"></a>
              <a href="#" id="Zone3" style="position: absolute; left: 66%; top: 67%; width: 25.5%; height: 20%;"></a>
              <a href="#" id="Zone3b" style="position: absolute; left: 75%; top: 42.5%; width: 23%; height: 22%;"></a>

            </div>
          </div>
        </div>
      </div>
      <!-- --#endregion-- -->
      <!-- #region Table Summary for Bin Locator-->
      <div class="row">
        <div class="col-12">
          <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
              <div class="shadow--dark border-radius-lg pt-4 pb-3" style="background-color: rgb(27, 107, 16);">
                <h6 class="text-white text-capitalize ps-3">Table Summary for Bin Locator</h6>
              </div>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Bin</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Location</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Zone</th>
                      <th class="text-secondary opacity-7"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div>
                            <img src="{% static 'img/team-2.jpg' %}" class="avatar avatar-sm me-3 border-radius-lg" alt="user1">
                          </div>
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">Smart Bin 1 </h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0">Gokongwei Hall</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm bg-gradient-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Zone 3</span>
                      </td>
                      <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div>
                            <img src="{% static 'img/team-3.jpg' %}" class="avatar avatar-sm me-3 border-radius-lg" alt="user2">
                          </div>
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">Smart Bin 2</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0">Henry Sy Sr. Hall</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm bg-gradient-secondary">Offline</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Zone 1</span>
                      </td>
                      <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div>
                            <img src="{% static 'img/team-4.jpg' %}" class="avatar avatar-sm me-3 border-radius-lg" alt="user3">
                          </div>
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">Smart Bin 3</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0">St. Joseph Hall</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm bg-gradient-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Zone 2</span>
                      </td>
                      <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div>
                            <img src="{% static 'img/team-3.jpg' %}" class="avatar avatar-sm me-3 border-radius-lg" alt="user4">
                          </div>
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">Smart Bin 4</h6>
                          </div>
                        </div>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0">Velasco Hall</p>
                      </td>
                      <td class="align-middle text-center text-sm">
                        <span class="badge badge-sm bg-gradient-success">Online</span>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Zone 2</span>
                      </td>
                      <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                          Edit
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- --#endregion -->
      {% include 'includes/footer.html' %}
    </div>
  </main>

{% endblock content %}
{% block scripts %}
<script>

document.addEventListener('DOMContentLoaded', function () {
  // Initial code to run on page load
  fetchPrioritizationData();
});

  function fetchPrioritizationData() {
    fetch('/api/getPrioritizationData')
      .then(response => response.json())
      .then(data => {
        // Group the bins by zone
        const bin1Data = data['Bin1'];
        const bin2Data = data['Bin2'];
        const bin3Data = data['Bin3'];
        const bin4Data = data['Bin4'];

        // Group bins by zone
        const binsByZone = groupBinsByZone([bin1Data, bin2Data, bin3Data, bin4Data]);

        // You can now access prioritized bins in each zone
        const Zone1Bins = binsByZone['Zone1'];
        const Zone2Bins = binsByZone['Zone2'];
        const Zone3Bins = binsByZone['Zone3'];
        console.log(Zone1Bins);
        console.log(Zone2Bins);
        console.log(Zone3Bins);

        // Prioritize the bins in each zone
        prioritizeBins(binsByZone);

      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
  }

  function groupBinsByZone(data) {
    const binsByZone = {
      'Zone1': [],
      'Zone2': [],
      'Zone3': [],
    };

    // Iterate through the data and group bins by zone
    data.forEach(bin => {
      const zoneNumber = bin.zone;

      // Assuming Zone1 corresponds to bins 1 and 2, Zone2 to bin 3, and Zone3 to bin 4
      if (zoneNumber === 1) {
        binsByZone['Zone1'].push(bin);
      } else if (zoneNumber === 2) {
        binsByZone['Zone2'].push(bin);
      } else if (zoneNumber === 3) {
        binsByZone['Zone3'].push(bin);
      }
    });

    return binsByZone;
  }
  function prioritizeBins(binsByZone) {
  for (const zoneKey in binsByZone) {
    const zone = binsByZone[zoneKey];

    // Remove "Zone " from zoneKey
    const zoneNumber = zoneKey.replace('Zone ', '');
    console.log(zoneNumber);
    // Now, apply the colors based on the zone's content
    const zoneColor = getZoneColor(zone);
    console.log(zoneColor)
    // Get the corresponding zone elements by their IDs
    const zoneElements = document.querySelectorAll(`[id^="${zoneNumber}"]`);
    console.log(zoneElements)
    if (zoneElements.length === 0) {
      console.error(`Zone elements not found for ${zoneKey}`);
      continue;
    }

    // Apply the calculated background color to all zone elements
    zoneElements.forEach(element => {
      element.style.backgroundColor = zoneColor;
    });
  }
}


  function getZoneColor(zone) {
    // Check if any bin in the zone has a flame
    const hasFlame = zone.some(bin => bin.flame === 1);

    // Find the maximum fill level in the zone
    const maxFillLevel = Math.max(...zone.map(bin => bin.fill_level));
    console.log(maxFillLevel)
    // Determine the color based on prioritization criteria
    if (hasFlame || maxFillLevel >= 90) {
      return 'rgba(255, 0, 0, 0.35)'; // Red
    } else if (maxFillLevel >= 75) {
      return 'rgba(255, 165, 0, 0.45)'; // Yellow
    } else {
      return 'rgba(0, 128, 0, 0.35)'; // Green
    }
  }

</script>
{% endblock scripts %}
 